@model List<fantasydg.Models.Player>

@{
    ViewData["Title"] = "Database View";
    Layout = "_Layout";
}

<h2>Database View</h2>

<style>
    table.player-stats {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

        table.player-stats th,
        table.player-stats td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: center;
        }

        table.player-stats thead {
            background-color: #f5f5f5;
        }

        table.player-stats tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table.player-stats th {
            position: sticky;
            top: 0;
            background: #eee;
            z-index: 1;
        }
</style>

<div>
    <label for="tournament">Tournament</label>
    <select id="tournament" name="name" class="form-control">
        <option value="">-- Select Tournament --</option>
        @foreach (var t in ViewBag.Tournaments)
        {
            <option value="@t.Name">@t.Name</option>
        }
    </select>

    <label for="division">Division</label>
    <select id="division" name="division" class="form-control">
        @foreach (var d in ViewBag.Divisions)
        {
            <option value="@(d == "All" ? "" : d)">@d</option>
        }
    </select>

    <label for="round">Round</label>
    <select id="round" name="round" class="form-control">
        <option value="">-- Select Round --</option>
    </select>
</div>

<hr />

<div id="results-container">
    @await Html.PartialAsync("PlayerView", Model)
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function loadRounds() {
            var tournament = $('#tournament').val();
            var division = $('#division').val();

            if (tournament && division) {
                $.getJSON('/Tournament/GetRounds', { name: tournament, division: division }, function (data) {
                    var roundSelect = $('#round');
                    roundSelect.empty().append($('<option>').val('').text('-- Select Round --'));
                    $.each(data, function (i, round) {
                        roundSelect.append($('<option>').val(round).text('Round ' + round));
                    });
                });
            }
        }

        function loadResults() {
            var tournament = $('#tournament').val();
            var division = $('#division').val();
            var round = $('#round').val();

            $.get('/Tournament/TournamentViewPartial', { name: tournament, division: division, round: round }, function (data) {
                $('#results-container').html(data);
            });
        }

        $('#tournament, #division').change(function () {
            loadRounds();
            loadResults();
        });

        $('#round').change(loadResults);

        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const selectedName = urlParams.get('name');
            const selectedDivision = urlParams.get('division');

            if (selectedName) {
                const $tournamentDropdown = $('#tournament');
                const match = $tournamentDropdown.find('option').filter(function () {
                    return $(this).text().trim() === selectedName;
                });
                if (match.length) {
                    $tournamentDropdown.val(match.val()).change();
                }
            }

            if (selectedDivision) {
                $('#division').val(selectedDivision).change();
            }
        });
    </script>
}
